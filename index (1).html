<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Digital Diary</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f5f7fa;
    color: #333;
    margin: 0;
    padding: 0;
  }
  body.dark {
    background: #121212;
    color: #eee;
  }
  .container {
    max-width: 800px;
    margin: 20px auto;
    padding: 10px;
  }
  .card {
    background: #fff;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  body.dark .card {
    background: #1f1f1f;
  }
  .hidden {
    display: none;
  }
  .center {
    max-width: 400px;
    margin: 100px auto;
    text-align: center;
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  input, select, textarea {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 10px;
    border: 1px solid #dcdfe3;
    background: #fff;
    color: #333;
  }
  body.dark input,
  body.dark select,
  body.dark textarea {
    background: #2c2c2c;
    color: #eee;
    border: 1px solid #444;
  }
  textarea {
    height: 150px;
    resize: vertical;
  }
  button {
    padding: 10px 20px;
    margin: 10px 5px 0 0;
    border: none;
    border-radius: 8px;
    background-color: #3498db;
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:hover {
    background-color: #2980b9;
  }
  ul#entries {
    list-style: none;
    padding: 0;
  }
  ul#entries li {
    background: #ecf0f1;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 10px;
    white-space: pre-wrap;
  }
  body.dark ul#entries li {
    background: #2e2e2e;
  }
</style>
</head>
<body>
  <!-- Lock Screen -->
  <div id="lock-screen" class="card center">
    <h2 id="pin-msg">ğŸ” Enter your PIN</h2>
    <input type="password" id="pin-input" placeholder="Enter PIN" />
    <button onclick="checkPIN()">Unlock</button>
  </div>

  <!-- Main App -->
  <div id="app" class="container hidden">
    <div class="header">
      <h1>ğŸ“ Digital Diary</h1>
      <button onclick="toggleDarkMode()">ğŸŒ“</button>
    </div>

    <div class="card">
      <label for="entry-date">ğŸ“… Date</label>
      <input type="date" id="entry-date" />
      
      <label for="mood">ğŸ§  Mood</label>
      <select id="mood">
        <option value="">ğŸ˜ Choose Mood</option>
        <option value="ğŸ˜Š">ğŸ˜Š Happy</option>
        <option value="ğŸ˜¢">ğŸ˜¢ Sad</option>
        <option value="ğŸ˜¡">ğŸ˜¡ Angry</option>
        <option value="ğŸ˜´">ğŸ˜´ Tired</option>
      </select>
      
      <label for="entry-text">âœï¸ Your Entry</label>
      <textarea id="entry-text" placeholder="Start writing your thoughts..."></textarea>

      <div>
        <button onclick="saveEntry()">ğŸ’¾ Save</button>
        <button onclick="exportEntries()">â¬‡ï¸ Export (.txt)</button>
        <button onclick="exportPDF()">ğŸ“„ Export PDF</button>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“š Past Entries</h2>
      <input type="text" id="search-box" placeholder="ğŸ” Search by date or mood" oninput="filterEntries()" />
      <ul id="entries"></ul>
    </div>
  </div>

  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    let entries = JSON.parse(localStorage.getItem("diaryEntries") || "[]");

    function checkPIN() {
      const input = document.getElementById("pin-input").value;
      const savedPIN = localStorage.getItem("userPIN");

      if (!savedPIN) {
        if(input.trim().length < 4){
          alert("Please set a PIN at least 4 characters long.");
          return;
        }
        localStorage.setItem("userPIN", input);
        alert("âœ… PIN set successfully!");
        unlockApp();
      } else if (input === savedPIN) {
        unlockApp();
      } else {
        alert("âŒ Wrong PIN!");
      }
    }

    function unlockApp() {
      document.getElementById("lock-screen").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      showEntries();
      applyTheme();
      setTodayDate();
    }

    function setTodayDate(){
      const dateInput = document.getElementById("entry-date");
      if(!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
      }
    }

    function saveEntry() {
      const date = document.getElementById("entry-date").value;
      const mood = document.getElementById("mood").value;
      const text = document.getElementById("entry-text").value.trim();

      if (!date || !text) {
        alert("Date and entry are required!");
        return;
      }

      entries.push({ date, mood, text });
      localStorage.setItem("diaryEntries", JSON.stringify(entries));
      document.getElementById("entry-text").value = "";
      showEntries();
    }

    function showEntries(filter = "") {
      const list = document.getElementById("entries");
      list.innerHTML = "";

      entries
        .filter(e =>
          e.date.includes(filter) ||
          (e.mood && e.mood.includes(filter)) ||
          e.text.toLowerCase().includes(filter.toLowerCase())
        )
        .forEach(entry => {
          const li = document.createElement("li");
          li.innerHTML = `<strong>${entry.date}</strong> ${entry.mood || ''}<br>${escapeHtml(entry.text)}`;
          list.appendChild(li);
        });
    }

    function filterEntries() {
      const term = document.getElementById("search-box").value.trim();
      showEntries(term);
    }

    function exportEntries() {
      const content = entries.map(e => `Date: ${e.date} ${e.mood || ''}\n${e.text}`).join('\n\n--------------------\n\n');
      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "digital-diary.txt";
      link.click();
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let y = 10;
      doc.setFontSize(14);
      doc.text("ğŸ“– Digital Diary Entries:", 10, y);
      y += 10;

      entries.forEach(entry => {
        const text = `ğŸ“… ${entry.date} ${entry.mood || ''}\n${entry.text}`;
        const splitText = doc.splitTextToSize(text, 180);
        if(y + splitText.length * 10 > 280){
          doc.addPage();
          y = 10;
        }
        doc.text(splitText, 10, y);
        y += splitText.length * 10 + 5;
      });

      doc.save("digital-diary.pdf");
    }

    function toggleDarkMode() {
      const isDark = document.body.classList.toggle("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    function applyTheme() {
      const theme = localStorage.getItem("theme");
      if (theme === "dark") {
        document.body.classList.add("dark");
      }
    }

    function escapeHtml(text) {
      var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    window.onload = function () {
      applyTheme();
      const savedPIN = localStorage.getItem("userPIN");
      if (!savedPIN) {
        document.getElementById("pin-msg").innerText = "ğŸ” Set your PIN for future access (min 4 chars)";
      } else {
        document.getElementById("pin-input").placeholder = "Enter PIN";
      }
    }
  </script>
</body>
</html>
